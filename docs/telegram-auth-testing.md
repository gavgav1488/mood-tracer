# Тестирование аутентификации через Telegram

## Предварительные требования

1. Настроенный бот Telegram (см. инструкцию в `supabase-auth-setup.md`)
2. Добавленные переменные окружения в `.env.local`:
   - `NEXT_PUBLIC_TELEGRAM_BOT_NAME`
   - `TELEGRAM_BOT_TOKEN`
3. Созданная таблица `telegram_users` в Supabase (выполнен скрипт `supabase-telegram-auth.sql`)

## Процесс тестирования

### 1. Локальное тестирование

Для локального тестирования необходимо использовать туннелирование, так как Telegram требует HTTPS для работы виджета авторизации:

1. Установите [ngrok](https://ngrok.com/download) или аналогичный инструмент для туннелирования
2. Запустите сервер разработки:
   ```bash
   pnpm dev
   ```
3. В отдельном терминале запустите ngrok:
   ```bash
   ngrok http 3000
   ```
4. Скопируйте HTTPS URL, предоставленный ngrok (например, `https://abcd1234.ngrok.io`)
5. Обновите настройки бота в BotFather:
   - Отправьте команду `/setdomain`
   - Выберите вашего бота
   - Введите домен из ngrok (без `https://`, например, `abcd1234.ngrok.io`)
6. Обновите переменную `NEXT_PUBLIC_SITE_URL` в `.env.local` на URL из ngrok
7. Перезапустите сервер разработки
8. Откройте URL из ngrok в браузере и протестируйте вход через Telegram

### 2. Тестирование на Vercel

1. Убедитесь, что переменные окружения добавлены в настройки проекта на Vercel:
   - `NEXT_PUBLIC_TELEGRAM_BOT_NAME`
   - `TELEGRAM_BOT_TOKEN`
2. Обновите настройки бота в BotFather:
   - Отправьте команду `/setdomain`
   - Выберите вашего бота
   - Введите домен вашего приложения на Vercel (например, `your-app.vercel.app`)
3. Разверните приложение на Vercel
4. Откройте ваше приложение и протестируйте вход через Telegram

## Проверка успешной аутентификации

После успешной аутентификации через Telegram:

1. Пользователь должен быть перенаправлен на страницу дневника
2. В таблице `telegram_users` в Supabase должна появиться новая запись с данными пользователя
3. В таблице `auth.users` должен быть создан новый пользователь с email в формате `telegram-{id}@telegram.auth`

## Устранение неполадок

### Виджет не отображается

- Проверьте, что переменная `NEXT_PUBLIC_TELEGRAM_BOT_NAME` установлена корректно
- Проверьте консоль браузера на наличие ошибок JavaScript
- Убедитесь, что домен в настройках бота соответствует домену, на котором запущено приложение

### Ошибка аутентификации

- Проверьте, что переменная `TELEGRAM_BOT_TOKEN` установлена корректно
- Проверьте логи сервера на наличие ошибок
- Убедитесь, что таблица `telegram_users` создана в Supabase

### Ошибка "Invalid hash"

- Проверьте, что токен бота введен правильно
- Убедитесь, что время на сервере синхронизировано (разница во времени может привести к ошибке проверки хеша)
- Проверьте, что домен в настройках бота соответствует домену, на котором запущено приложение
